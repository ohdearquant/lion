<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>lion UI</title>
    <style>
      #logs {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
      }
      .agent-list, .plugin-list {
        margin: 20px 0;
      }
      .agent-item, .plugin-item {
        margin: 5px 0;
        padding: 5px;
        border: 1px solid #eee;
      }
      .section {
        margin: 20px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      textarea {
        width: 100%;
        min-height: 100px;
        margin: 10px 0;
      }
      .search-form {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .search-form input {
        flex: 1;
        padding: 5px;
      }
      .search-results {
        margin-top: 10px;
        border-top: 1px solid #eee;
      }
    </style>
  </head>
  <body>
    <h1>lion UI - Agent Management</h1>

    <div class="section">
      <h2>Spawn New Agent</h2>
      <input type="text" id="promptInput" placeholder="Enter agent prompt" />
      <button id="spawnBtn">Spawn Agent</button>
    </div>

    <div class="agent-list section">
      <h2>Active Agents</h2>
      <div id="agentList"></div>
    </div>

    <div class="section">
      <h2>Plugin Management</h2>
      <div>
        <h3>Load Plugin</h3>
        <textarea
          id="manifestInput"
          placeholder="Enter plugin manifest (TOML format)"
        >
name = "calculator"
version = "0.1.0"
description = "A simple calculator plugin that can perform basic arithmetic operations"
entry_point = "../../target/debug/calculator_plugin"
permissions = []
driver = "native"

[functions.add]
name = "add"
description = "Add two numbers"
input_schema = { type = "object", properties = { a = { type = "number" }, b = { type = "number" } } }
output_schema = { type = "object", properties = { result = { type = "number" } } }

[functions.subtract]
name = "subtract"
description = "Subtract two numbers"
input_schema = { type = "object", properties = { a = { type = "number" }, b = { type = "number" } } }
output_schema = { type = "object", properties = { result = { type = "number" } } }

[functions.multiply]
name = "multiply"
description = "Multiply two numbers"
input_schema = { type = "object", properties = { a = { type = "number" }, b = { type = "number" } } }
output_schema = { type = "object", properties = { result = { type = "number" } } }

[functions.divide]
name = "divide"
description = "Divide two numbers"
input_schema = { type = "object", properties = { a = { type = "number" }, b = { type = "number" } } }
output_schema = { type = "object", properties = { result = { type = "number" } } }
</textarea
        >
        <button id="loadPluginBtn">Load Plugin</button>
      </div>

      <div class="plugin-list">
        <h3>Active Plugins</h3>
        <div id="pluginList"></div>
      </div>

      <div>
        <h3>Invoke Plugin</h3>
        <select id="pluginSelect">
          <option value="">Select a plugin...</option>
        </select>
        <input type="text" id="pluginInput" placeholder='{"a": 5, "b": 3}' />
        <button id="invokePluginBtn">Invoke Plugin</button>
      </div>
    </div>

    <div class="section">
      <h2>Real-time Logs</h2>
      <div class="search-form">
        <input type="text" id="agentSearch" placeholder="Agent ID" />
        <input type="text" id="pluginSearch" placeholder="Plugin ID" />
        <input type="text" id="textSearch" placeholder="Search text" />
        <button id="searchBtn">Search</button>
      </div>

      <div class="search-results" id="searchResults" style="display: none">
        <h3>Search Results</h3>
        <div id="searchContent"></div>
      </div>
      <div id="logs"></div>
    </div>

    <script>
      // Set up SSE for real-time logs
      const evtSource = new EventSource("/events");
      const logsDiv = document.getElementById("logs");

      evtSource.onmessage = (event) => {
        const newLog = document.createElement("div");
        newLog.textContent = event.data;
        logsDiv.appendChild(newLog);
        logsDiv.scrollTop = logsDiv.scrollHeight;

        // If this is a plugin-related message, refresh the plugin list
        if (
          event.data.includes("Plugin") &&
          (event.data.includes("loaded") ||
            event.data.includes("invoked"))
        ) {
          fetchPlugins();
        }
      };

      // Function to spawn a new agent
      async function spawnAgent() {
        const promptInput = document.getElementById("promptInput");
        const prompt = promptInput.value.trim();

        if (!prompt) {
          alert("Please enter a prompt");
          return;
        }

        try {
          const res = await fetch("/api/agents", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt }),
          });

          const data = await res.json();
          if (data.error) {
            alert(data.error);
          } else {
            promptInput.value = "";
            fetchAgents(); // Refresh agent list
          }
        } catch (e) {
          alert("Error spawning agent: " + e);
        }
      }

      // Function to fetch and display active agents
      async function fetchAgents() {
        try {
          const res = await fetch("/api/agents");
          const agents = await res.json();

          const agentList = document.getElementById("agentList");
          agentList.innerHTML = agents.map((agent) => `
                    <div class="agent-item">
                        Agent ${agent.id} - Status: ${agent.status}
                    </div>
                `).join("");
        } catch (e) {
          console.error("Error fetching agents:", e);
        }
      }

      // Function to load a plugin
      async function loadPlugin() {
        const manifestInput = document.getElementById("manifestInput");
        const manifest = manifestInput.value.trim();

        if (!manifest) {
          alert("Please enter a plugin manifest");
          return;
        }

        try {
          const res = await fetch("/api/plugins", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ manifest }),
          });

          if (!res.ok) {
            const error = await res.text();
            throw new Error(error);
          }

          const data = await res.json();
          console.log("Plugin loaded:", data);
          fetchPlugins(); // Refresh plugin list
        } catch (e) {
          alert("Error loading plugin: " + e);
        }
      }

      // Function to fetch and display plugins
      async function fetchPlugins() {
        try {
          const res = await fetch("/api/plugins");
          const plugins = await res.json();

          const pluginList = document.getElementById("pluginList");
          pluginList.innerHTML = plugins.map((plugin) => `
                    <div class="plugin-item">
                        Plugin ${plugin.id} - ${plugin.name} (${plugin.version})
                        <br>Permissions: ${
            plugin.permissions.join(", ")
          }
                    </div>
                `).join("");

          // Update plugin select dropdown
          const pluginSelect = document.getElementById("pluginSelect");
          pluginSelect.innerHTML = `
                    <option value="">Select a plugin...</option>
                    ${
            plugins.map((plugin) => `
                        <option value="${plugin.id}">${plugin.name} (${plugin.version})</option>
                    `).join("")
          }
                `;
        } catch (e) {
          console.error("Error fetching plugins:", e);
        }
      }

      // Function to invoke a plugin
      async function invokePlugin() {
        const pluginSelect = document.getElementById("pluginSelect");
        const pluginInput = document.getElementById("pluginInput");
        const pluginId = pluginSelect.value;
        const input = pluginInput.value.trim();

        if (!pluginId) {
          alert("Please select a plugin");
          return;
        }

        if (!input) {
          alert("Please enter plugin input");
          return;
        }

        try {
          const res = await fetch(`/api/plugins/${pluginId}/invoke`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              function: "add",
              args: JSON.parse(input),
            }),
          });

          if (!res.ok) {
            const error = await res.text();
            throw new Error(error);
          }

          const data = await res.text();
          console.log("Plugin invoked:", data);
          pluginInput.value = "";
        } catch (e) {
          alert("Error invoking plugin: " + e);
        }
      }

      // Function to search logs
      async function searchLogs() {
        const agent = document.getElementById("agentSearch").value
          .trim();
        const plugin = document.getElementById("pluginSearch").value
          .trim();
        const text = document.getElementById("textSearch").value.trim();

        if (!agent && !plugin && !text) {
          document.getElementById("searchResults").style.display =
            "none";
          return;
        }

        try {
          const params = new URLSearchParams();
          if (agent) params.append("agent", agent);
          if (plugin) params.append("plugin", plugin);
          if (text) params.append("text", text);

          const res = await fetch(`/api/logs?${params.toString()}`);
          const logs = await res.json();

          const searchResults = document.getElementById(
            "searchResults",
          );
          const searchContent = document.getElementById(
            "searchContent",
          );

          searchResults.style.display = "block";
          searchContent.innerHTML = logs.map((log) => `
            <div>[${
            new Date(log.timestamp).toLocaleString()
          }] ${log.message}</div>
          `).join("");
        } catch (e) {
          console.error("Error searching logs:", e);
          alert("Error searching logs: " + e);
        }
      }

      // Set up event listeners
      document.getElementById("spawnBtn").onclick = spawnAgent;
      document.getElementById("loadPluginBtn").onclick = loadPlugin;
      document.getElementById("invokePluginBtn").onclick = invokePlugin;
      document.getElementById("searchBtn").onclick = searchLogs;

      // Initial data fetch
      document.getElementById("searchResults").style.display = "none";
      fetchAgents();
      fetchPlugins();

      // Refresh data periodically
      setInterval(fetchAgents, 5000);
      setInterval(fetchPlugins, 5000);
    </script>
  </body>
</html>
